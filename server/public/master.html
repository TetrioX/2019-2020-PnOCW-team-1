<!DOCTYPE html>
<html>
<head>
	<meta charsert= "uft-8">
	<title>
		Master Page
	</title>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<h1 >Ik ben een master</h1>
	<input type="color" id="color">
	<div id="bcPicker"></div>

	<div class="contentarea">
		<div class="camera">
			<video id="video">Video stream not available.</video>
			<button id="startbutton">Take photo</button>
		</div>
		<canvas style="display:none" id="canvas">
		</canvas>
		<div class="output">
			<img id="photo">
		</div>
	</div>

	<script >

		// Make Connection
		var socket = io('/master');

		//listen for events from server
		socket.on('registerMaster',function(data){
			window.location.href='/';
		});

		//Emit events to server
		var backgroundButton =document.getElementById('changeBackgroundColor');
		var colorPicker = document.getElementById('color');
		var colorValue =colorPicker.value;

		colorPicker.addEventListener('input',function(){
			colorValue = colorPicker.value
		});

		var slaveButtons = {};

		function createSlaveButton(slave) {
			var btn = document.createElement("BUTTON");
			btn.innerHTML = "Change color of " + slave;
			document.body.appendChild(btn);
			btn.addEventListener('click',function(){
				 socket.emit('changeBackgroundColor',{
					colorValue: colorValue,
					id: slave
				});
			});
			slaveButtons[slave] = btn;
		}

		function removeSlaveButton(slave) {
			if (slave in slaveButtons) {
				slaveButtons[slave].remove();
				delete slaveButtons[slave];
			}
		}

		socket.on('slaveSet',function(data){
			for (slave of data.slaves) {
				createSlaveButton(slave);
			}
		});

		socket.on('registerSlave',function(data){
			createSlaveButton(data);
		});

		socket.on('removeSlave',function(data){
			removeSlaveButton(data)
		});

		//Foto nemen

		(function() {
			// |streaming| indicates whether or not we're currently streaming
			// video from the camera. Obviously, we start at false.

			var streaming = false;

			// The various HTML elements we need to configure or control. These
			// will be set by the startup() function.

			var video = null;
			var canvas = null;
			var photo = null;
			var startbutton = null;

			function startup() {
				video = document.getElementById('video');
				canvas = document.getElementById('canvas');
				photo = document.getElementById('photo');
				startbutton = document.getElementById('startbutton');

				navigator.mediaDevices.getUserMedia({video: true, audio: false})
						.then(function (stream) {
							video.srcObject = stream;
							video.play();
						})
						.catch(function (err) {
							console.log("An error occurred: " + err);
						});

				video.addEventListener('canplay', function (ev) {
					if (!streaming) {
						streaming = true;
					}
				}, false);

				startbutton.addEventListener('click', function (ev) {
					takepicture();
					ev.preventDefault();

				}, false);
			}

			// Capture a photo by fetching the current contents of the video
			// and drawing it into a canvas, then converting that to a PNG
			// format data URL. By drawing it on an offscreen canvas and then
			// drawing that to the screen, we can change its size and/or apply
			// other changes before drawing it.

			function takepicture() {
				var context = canvas.getContext('2d');
				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				context.drawImage(video, 0, 0);

				var Picurl = canvas.toDataURL('image/png');
				photo.setAttribute('src', Picurl);

				socket.emit('upload-image', {
					image: true,
					buffer: canvas.toDataURL()
				});
			}


			// Set up our event listener to run the startup process
			// once loading is complete.
			window.addEventListener('load', startup, false);
		})();

	</script>
</body>
</html>
